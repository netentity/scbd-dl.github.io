/* 
* --------------------
* | adEngine         |
* --------------------
* @version: 2.0
* @author: A.I Raju
* @copyright: 2025
* @License: MIT
*/

/* adEngine Docs */
// 1. Ad Request
// 2. Prepare Ads
// 3. Render Ads

/* adEngine Start */
 var adEngine = {

    Status: {
        Ads: false,
        popBanner: false,
    },
    Config:{
        refreshTime: 30000,
        forceDefaultRefreshTime: false,
        popBannerEnable: true,
        popBannerDelay: 1000,
        popBannerMaxDisplay: 0,
        popBannerDisplayAfterClose: 30000,
        set: function( conf ){
            for( key in conf ){
                adEngine.Config[key] = conf[key];
            }
        }
    },
    Ads: {},
    Placement: {},
    Serve: {
        horizontal: [],
        vertical: [],
        box: [],

        add: function(adType, adId){
            if( adType =='' || adId =='' || adType === undefined || adId === undefined ){
                return false;
            }
            if( adEngine.Serve[adType].indexOf( adId ) === -1 ){
                adEngine.Serve[adType].push(adId);
                return true;
            }else{
                return false;
            }
        },

        remove: function(adType, adId){
            if( adType =='' || adId =='' || adType === undefined || adId === undefined ){
                return false;
            }
            var ServeIndex = adEngine.Serve[adType].indexOf( adId );
            if( ServeIndex > -1 ){
                adEngine.Serve[adType].splice( ServeIndex, 1 );
                return true;
            }else{
                return false;
            }
        },

        has: function(adType, adId){
            if( adType =='' || adId =='' || adType === undefined || adId === undefined ){
                return false;
            }
            return adEngine.Serve[adType].indexOf( adId ) > -1 ? true:false;
        },
    },

    /*
    * ----------------------
    * | Cookie Controller  |
    * ----------------------
    *
    * @Author: A.I Raju
    * @Version: 1.0
    * @Copyright: 2024
    * @License: MIT
    *
    * Since V1.0
    */
    Cookie: {
        
        /*
        * Get Cookie
        * Ref: https://www.w3schools.com/js/js_cookies.asp
        */
        get: function( cname ){
            let name = cname + "=";
            let decodedCookie = decodeURIComponent( document.cookie );
            let ca = decodedCookie.split(';');
            for( let i = 0; i <ca.length; i++ ) {
                let c = ca[i];
                while ( c.charAt(0) == ' ' ) {
                    c = c.substring(1);
                }
                if ( c.indexOf(name) == 0 ) {
                    return c.substring( name.length, c.length );
                }
            }
            return "";
        },
        
        /*
        * Set Cookie
        * Ref: https://www.w3schools.com/js/js_cookies.asp
        */
        set: function( cname, cvalue, exdays = 7, path = '/', domain = false ){
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        
        if( domain === false ){
            domain = new URL(document.location).host.replace('www.', '');
        }
        
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain="+domain+";Secure";
        },
        
        /*
        * Has Cookie
        */
        has: function( cookie_name ){
            if( this.get( cookie_name ) ){ return true; }else{ return false; }
        }
        
    },

    /*
    * -----------------------------
    * | Url Controller Functions  |
    * -----------------------------
    *
    * @Author: A.I Raju
    * @Version: 1.0
    * @Copyright: 2024
    * @License: MIT
    *
    * Since V1.0
    */
    Url: {
        
        /*
        * Get Query Parameters From Url.
        */
        get: function( param )
        {
            var currentUrl = window.location.search.substring(1),
            urlVar = currentUrl.split('&'),
            paramName,
            i;
            for (i = 0; i < urlVar.length; i++) {
                paramName = urlVar[i].split('=');

                if (paramName[0] === param) {
                    return paramName[1] === undefined ? false : decodeURIComponent(paramName[1]);
                }
            }
            return false;
        },
        
        /*
        * Get Clean Page Url Without parameters.
        */
        getCleanUrl: function( url = false ){
            var current_url = new URL( (url === false ? window.location.href:url) );
            var clean_url = current_url.href.replace(current_url.hash, '');
            return clean_url.replace(current_url.search, '');
        },
        
        /* Current Page Url */
        currentUrl: function(){
            return window.location.href;
        },
        
        /* Url.parseUrl(); return object */
        parseUrl: function( url = false){
            if( !url )
            {
                return window.location;
            }else{
                return new URL( url );
            }
        },	
        
        /* Url Encode Function */
        encode: function( url )
        {
            return url !=='' ? encodeURIComponent( url ):false;
        },
        
        /* Url Encode Function */
        decode: function( url )
        {
            return url !=='' ? decodeURIComponent( url ):false;
        },
        
        /* URL Redirector */
        go: function( url )
        {
            if( url !=='' )
            {
                window.location = url;
            }else{
                return false;
            }
        },
        
        /*
        * Url.isValidUrl(); to detect the url is valid or not.
        * Ref: https://stackoverflow.com/questions/5717093/check-if-a-javascript-string-is-a-url
        */
        isValidUrl: function( string ) {
        var res = string.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);
        return ( res !== null )
        },
        
        /*
        * Url.getValidUrl();
        * This function is used for making the url valid.
        * If any url don't have protocol, hostname etc. then this function will make it valid.
        * Version 1
        * Since V1
        */
        getValidUrl: function( url ){
            if( url.substring(0, 2) === '//' ) url = 'http:'+url;
            if( url[0] === '/' ) url = 'http:/'+url;
            
            if( url.substring(0, 7) === 'http://' || url.substring(0, 8) === 'https://' ){
                
                url = url;
                
            }else{
                var currentPageUrl = this.parseUrl( this.currentUrl() );
                url = 'http://'+currentPageUrl.hostname+'/'+url;
            }
            
            return url;
        }
    },

    /*
    * ---------------------------------------------
    * | Event Tracker For Google Analytics        |
    * ---------------------------------------------
    *
    * @Author: A.I Raju
    * @Copyright: A.I Raju 2024
    * @License: MIT
    * @Version: 1.0 (Beta)
    * 
    * 
    * Since V1;
    */

    eventTracking: {
        send: function( event_name ){
            if( typeof gtag == 'function' ){
                gtag( 'event', event_name, {event_name:event_name} );
            }
        },

        trackIframeClicks: function(){
            /* Iframe Click Event Tracking... */
            var register_click = 0;
            var inTagPos = 0;
            document.addEventListener('mouseover', function(e){
                
                var inTag = e.target.tagName;
                if( inTag == 'IFRAME' ){
                inTagPos = 1;
                }
            
            var outTag;
            document.addEventListener('mouseout', function(e){
                outTag = e.target.tagName;
                if( outTag === 'IFRAME' )
                {
                    register_click = 0;
                    inTagPos = 0;
                }
                
            })
                
                window.addEventListener('blur', function(event){
                    if( inTag == 'IFRAME' && inTagPos == 1 && register_click == 0 ){
                        register_click = 1;
                        
                        /* Ready for Send Event */
                        adEngine.eventTracking.send( 'AE_iframe_click' );
                    }
                })
            
            if( inTag !== 'IFRAME' )
                {
                window.focus();
                }
                
                window.focus();
            });
        }
    },


    /**
     * adEngine Ad Request 
     * @version 1.0
     * @author A.I Raju
     * @copyright 2025
     */

    adRequest: {

        getAds: function( endpoint ){
            if( endpoint == '' ){ return false; }
            var xmlhttp;
            // compatible with IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
                    var data = JSON.parse(xmlhttp.responseText);
                    if( data.hasOwnProperty('Ads') && data.Ads.length !== 0 ){
                        adEngine.Status.Ads = true;
                        adEngine.Ads = data.Ads;
                        adEngine.eventTracking.send( "AE_getAds" );
                    }else{
                        adEngine.Status.Ads = false;
                    }
                }
            }
            xmlhttp.open("GET", endpoint, true);
            xmlhttp.send();
        },
    },

    /**
     * adEngine Ad Render 
     * @version 1.0
     * @author A.I Raju
     * @copyright 2025
     */

    Render: {
        getPlacement: function(){
            var adPlace = document.querySelectorAll('.adEngine');
            if( adPlace.length !== 0 ){
                adEngine.Placement.total = adPlace.length;
                if( !adEngine.Placement.hasOwnProperty('ids') ){
                    adEngine.Placement.ids = [];
                }
                if( !adEngine.Placement.hasOwnProperty('type') ){
                    adEngine.Placement.type = [];
                }
                adPlace.forEach(function(i, o){
                    if( i.hasAttribute('data-type')  ){
                        var type = i.getAttribute('data-type');
                        if( adEngine.Placement.type.indexOf(type) === -1 ){
                            adEngine.Placement.type.push(type);
                        }

                        if( !i.hasAttribute('id') ){
                            var adPlaceId = 'adEngine_placement_'+(o + 1);
                            if( adEngine.Placement.ids.indexOf(adPlaceId) === -1 ){
                                i.id = adPlaceId;
                                adEngine.Placement.ids.push(adPlaceId);
                            }
                        }
                    }
                })
            }
        },

        renderPlacement: function(){
            adEngine.Placement.ids.forEach(function(i,o){
                adEngine.Render.displayAd( i );
            })
        },

        displayAd: function( placementId ){
            var placement = document.querySelector( '#'+placementId );
            if( placement && placement.hasAttribute('data-type') ){
                var placementType = placement.getAttribute( 'data-type' );
                if( adEngine.Ads.hasOwnProperty( placementType ) ){
                    var gettingAds = adEngine.Render.selectAd( placementType, placement );
                    if( gettingAds ){
                        adEngine.Render.createAdFrame( gettingAds, placement, placementId, placementType );
                    }
                }
            }
        },

        selectAd: function( adType, placement ){
            var placementWidth = placement.parentNode.offsetWidth > 120 ? placement.parentNode.offsetWidth:window.innerWidth;

            var getRandomNumber = function( limit = 1){
                var randomNumber = Math.round( Math.random() * limit );
                return randomNumber === undefined ? getRandomNumber( limit ):randomNumber;
            }

            if( adEngine.Ads.hasOwnProperty(adType) && adEngine.Ads[adType].length > 0 ){
                var getRandomAd = function(adType, placement, placementWidth){
                    var selectedAd = adEngine.Ads[adType][Math.round( Math.random() * adEngine.Ads[adType].length )];
                    if( selectedAd =='' || selectedAd === undefined ){
                        return getRandomAd( adType, placement, placementWidth );
                    }else{
                        if( selectedAd.width >= placementWidth ){
                            var findFitableAds = [];
                            for( let index = 0; index < adEngine.Ads[adType].length; index++ ){
                                var fitAds = adEngine.Ads[adType][index];
                                if( fitAds.width <= placementWidth ){
                                    findFitableAds.push(fitAds);
                                }
                            }
                            if( findFitableAds.length === 0 ){
                                return false;
                            }
                            if( findFitableAds.length === 1 ){
                                return findFitableAds[0];
                            }else{
                                return findFitableAds[getRandomNumber( findFitableAds.length )]; 
                            }
                        }else{
                            return selectedAd;
                        }
                    }
                }
                if( adEngine.Ads[adType].length !== adEngine.Serve[adType].length ){
                    for( let index = 0; index < adEngine.Ads[adType].length; index++ ){
                        var selectedAd = adEngine.Ads[adType][index];
                        if( selectedAd.width >= placementWidth ){
                            if( !adEngine.Serve.has( adType, selectedAd.id ) ){
                                adEngine.Serve.add( adType, selectedAd.id );
                                return getRandomAd(adType, placement, placementWidth);
                            }
                        }else{
                            if( !adEngine.Serve.has( adType, selectedAd.id ) ){
                                adEngine.Serve.add( adType, selectedAd.id );
                                return selectedAd;
                            }
                        }
                    }
                }else{
                    return getRandomAd( adType, placement, placementWidth );
                }

            }else{
                return false;
            }
        },

        createAdFrame: function( ad, placement, placementId, adType ){
            placement.innerHTML = '';
            placement.setAttribute('style', 'background-color: transparent;width:'+ad.width+'px !important;height:'+ad.height+'px !important;margin:auto !important;');
            placement.setAttribute('width', ad.width);
            placement.setAttribute('height', ad.height);
            placement.setAttribute('data-width', ad.width);
            placement.setAttribute('data-height', ad.height);
            placement.setAttribute('data-ads-id', ad.id);
            var refreshTime;
            if( ad.hasOwnProperty('refreshTime') ){
                refreshTime = ad.refreshTime;
            }else{
                refreshTime = adEngine.Config.refreshTime;
            }

            if( adEngine.Config.forceDefaultRefreshTime ){
                refreshTime = adEngine.Config.refreshTime;
            }

            var srcDoc = `<!doctype html><html lang="en"><head><title>${document.title}</title><meta charset="UTF-8" /><meta name="description" content="${document.title}" /><style>*{padding: 0 !important;margin:0 !important;box-sizing: border-box;font-family: "Open Sans", "Roboto", "Rubik", sans-serif}.ads-by{font-weight: bold;position:absolute;top:0;right:0;padding: 2px 5px !important;font-size:10px;background:#FFE31A;color:#000;border-bottom-left-radius: 5px;box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);text-decoration: none !important;cursor: pointer;transition: all 0.3s}.ads-by:hover::before{content: "Ad served by";margin-right: 3px;font-weight: normal}</style></head><body><div class="ads-by">AE</div>${ad.ad_code}</body><script>window.addEventListener('DOMContentLoaded', () => {parent.adEngine.eventTracking.send( "AE_Impression" );var adEngineInterval = setInterval(()=>{clearInterval(adEngineInterval);parent.adEngine.eventTracking.send( "AE_Refresh" );parent.adEngine.Render.displayAd("${placementId}");}, ${refreshTime});});</script></html>`;

            var iframe = document.createElement( 'iframe' );
            iframe.setAttribute('src', '');
            iframe.setAttribute('srcDoc', srcDoc);
            iframe.setAttribute('style', 'width:'+ad.width+'px !important;height:'+ad.height+'px !important;border:0px;padding:0;overflow:hidden;background-color:#f1f1f120;');
            iframe.setAttribute('data-ads-by', ad.name);
            iframe.setAttribute('data-type', adType);
            iframe.setAttribute('scrolling', 'off');
            iframe.setAttribute('frameborder', '0');
            placement.appendChild( iframe );
        },

        popBanner: function(){
            var popBannerTemplate = `<div style="height:auto;width:auto;min-width:250px;position:fixed;bottom:0;right:0;margin-right:0px;margin-bottom:0px;text-align:center;"><div style="font-faimily:arial;font-weight:bold;text-align:center;background:red;color:#fff;height:20px;line-height:20px;font-size:11px;width:55px;margin:auto;border-top-right-radius:3px;border-top-left-radius:3px;cursor:pointer;font-family:"Open Sans", "Roboto", "Rubik", sans-serif;" onclick="adEngine.Render.popBannerClose()"><svg xmlns="http://www.w3.org/2000/svg" style="width:11px !important;height:11px !important;margin-top:-2px;" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16"><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708"/></svg> Close</div><div style="display:block;margin:0px !important;" class="adEngine" data-type="box" id="popBanner_1"></div></div>`;
            var div = document.createElement('div');
            div.id = "adEnginePopBanner";
            div.innerHTML = popBannerTemplate;
            document.body.appendChild( div );
            adEngine.Render.displayAd( "popBanner_1" );
        },

        popBannerDisplay: function(){
            if( adEngine.Config.popBannerEnable ){
                if( adEngine.Config.popBannerDelay > 0 ){
                    var popBannerStartTime = setInterval(()=>{
                        clearInterval( popBannerStartTime );
                        adEngine.Render.popBanner();
                        adEngine.Cookie.set( 'popBanner', 1, 1 );
                        adEngine.Status.popBanner = true;
                    }, adEngine.Config.popBannerDelay );
                }else{
                    adEngine.Render.popBanner();
                    adEngine.Status.popBanner = true;
                    adEngine.Cookie.set( 'popBanner', 1, 1 );
                }
            }
        },

        popBannerClose: function(){
            document.querySelector( "#adEnginePopBanner" ).addEventListener('click', () => {
                document.querySelector('#adEnginePopBanner').remove();
                adEngine.eventTracking.send("AE_PopBannerClosed");
                adEngine.Status.popBanner = false;
                var popBannerMaxDisplay = adEngine.Cookie.has('popBanner') ? adEngine.Cookie.get('popBanner'):0;
                popBannerMaxDisplay = parseInt( popBannerMaxDisplay );

                if( adEngine.Config.popBannerEnable ){
                    if( adEngine.Config.popBannerMaxDisplay == 0 || popBannerMaxDisplay !== adEngine.Config.popBannerMaxDisplay ){
                        var popBannerNextDisplayTime = setInterval(()=>{
                            clearInterval( popBannerNextDisplayTime );
                            adEngine.Render.popBanner();
                            adEngine.Status.popBanner = true;
                            adEngine.Cookie.set( 'popBanner', (popBannerMaxDisplay + 1), 1 );
                        }, adEngine.Config.popBannerDisplayAfterClose);
                    }
                }

            });
        }

    },

    /* Start Ad Engine */
    start: function(){
        adEngine.Render.getPlacement();
        var processAdTimerr = setInterval( function(){
            if( adEngine.Status.Ads === true ){
                clearInterval( processAdTimerr );
                adEngine.eventTracking.trackIframeClicks();
                adEngine.Render.renderPlacement();
                adEngine.Render.popBannerDisplay();
            }
        }, 100 );
    }
};
